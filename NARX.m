function [y1,xf1,xf2] = myNeuralNetworkFunction(x1,x2,xi1,xi2)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 15-Jun-2018 01:41:16.
%
% [y1,xf1,xf2] = myNeuralNetworkFunction(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 2xTS matrix, input #1
%   x2 = 1xTS matrix, input #2
%   xi1 = 2x2 matrix, initial 2 delay states for input #1.
%   xi2 = 1x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 1xTS matrix, output #1
%   xf1 = 2x2 matrix, final 2 delay states for input #1.
%   xf2 = 1x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [0.00605886802986788;-8330.34891715];
x1_step1.gain = [0.00594983054553932;0.000240085981978801];
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = 0;
x2_step1.gain = 0.00101684770681708;
x2_step1.ymin = -1;

% Layer 1
b1 = [-3.0512703374870637774;-2.3583277812486937997;2.4478027022238353361;2.474806411958704544;1.0044562792433169296;-1.9416575065074597184;2.6744303379973630719;0.63430902845698255987;-1.9521232888898829572;-0.80810816208826030671;-1.3732065635036354578;0.76047941509076377731;0.64818087931457424311;-0.81086556273449350574;-0.158200420397196867;-0.4751942749561564594;-0.21470839364908916869;0.67065460256350528656;-0.31854998005281043305;-0.15253702787224240889;0.33467213460418665516;-0.78206845680073899807;0.9959815915178034107;-1.1873085787087274134;1.1298755547288674705;0.089927681598893097203;0.098095778203565159314;1.7166331017436287087;-1.6810849467419728409;1.3891168627546746084;-0.7323781281220054229;1.9839140776524719634;1.3854175750040207404;1.630543706070545884;-1.2935953769353227827;-2.2343469875239065914;-2.5071749172444834919;2.6019473374314712188;-2.4772810676777057282;-2.8149710154913263338];
IW1_1 = [1.9180852152251433029 -0.22917092517964601783 -0.28218101434583547915 0.72784210110583924536;0.019051783077402090899 1.3910007496136991278 1.0359646735959142649 0.18119533506544283075;-0.85745488720685192341 -1.0232387688965438599 -0.53991323248021871883 -1.7502095962568304799;-0.76929388184681923857 -1.2847710517818904385 -0.26784874739263914156 1.5316921483449628116;-3.0748173007005314972 1.5122069402320901244 -1.3119198138791894337 1.3060671194291535446;0.86277090835374969924 -1.0972311947100332752 -2.3213534469290042495 -1.0714447105599125276;-1.1284261503000545535 -0.57411805943036164912 0.64558130097007404569 -0.070199259910428704612;-0.44011365581248362844 0.87003143558178186456 -1.9853376455784592647 0.36467378434463071368;1.0056811276885966322 -1.2856827293325439054 -0.41099782334641254966 0.42624696420230923088;0.27778257441860548793 -0.070141942060353942856 0.058624209698293988646 1.2228306319957549242;0.85070261278920078496 0.45691386195551353389 0.91533468327303457723 -1.6577136477093998845;-0.32714939494951655874 -2.0005082335263084659 -0.60802679698914596784 1.6396290266762509891;-1.6635127554011071016 -1.8101120816274625103 -0.55771547070733151763 -0.74030810635790522678;1.6578491682503075921 -0.74979084517982130809 -0.25623343389631886291 1.7816283722036980741;0.78962182716178763719 0.6574492218992586956 0.71844197589195890608 1.6343658313194535658;0.31905636682069177246 0.41428315264583831512 -1.3442899389755116335 0.6023223120693725896;-0.68551339020739010532 -0.65555725617648197279 -0.81710495837063268354 2.045763586932622502;-0.66886559662023292727 -0.95632720980075713868 -0.40497111410109570828 -1.2814653477839266227;-0.83466933610429938639 -0.99767750974911506567 -0.14762633074813807932 0.046438230890052667466;1.3546616927059835778 0.25260736050740506542 0.88275467416652231289 0.89598789973073378334;1.1041126918219965614 0.65424620524500853858 1.3202577495398806207 0.55000572904201461277;-1.8160755915037942732 -0.70274954255766686195 -0.65517721693446950848 0.11880612787921768225;1.7179661152370526711 -0.02804515964292061958 -1.2369496836089788339 -0.53438394067484118466;-0.52661929262098894355 -0.97548084458669204189 -0.30433131420710191062 0.96338236171925839546;0.3003561204270829843 -0.062791924016671302189 1.1392627422936598691 1.1105661794981360746;-1.3199409455346837738 -0.8134368033640314577 0.90117569760877935803 1.1753220673751290093;-1.624136320412127521 0.54989751137445863627 0.11931534405283242273 -1.5163392125668631039;0.94320119874093211187 1.3066630101209040227 -1.2436858355495874484 1.0576746156753495942;0.24569490031916807471 0.80238612511158313723 -0.18886575514649386887 1.9704327286661411645;0.40542270864632995453 1.6700183235201691012 1.2412464024660583295 -0.14120882592325947891;-0.3754506796513528144 -1.0933105119407653394 0.37194282303797948641 -1.4178944021563273381;0.77763368627924844834 -1.237451031515838018 -2.1074513075491267955 1.0096247299251079887;0.60076784078703560077 1.4505720590899782163 -1.1640722477558838044 1.9529455889801741186;1.6739801073564990475 -0.83813974715512395974 -0.62890633870953882578 0.21579754798680553241;-1.5469088145562412961 -0.86557769918047933189 -0.046003566287737426843 -1.1159363020896486685;-1.1068478025393904129 0.50522888187734826815 -1.5896197669518206119 -0.41756882197040962046;-0.33845616146120255374 -0.7132362641295457717 -1.1234374929957038347 -1.1154663636258772552;0.090410365046589571958 -0.320677012079192858 0.99776494952397409843 -0.61964652936394770677;-0.91618075276378707628 -1.9796367528695519855 -0.95536438516331789739 -0.58179432933067143363;0.14558167397190791004 -1.3133793825750803563 -0.49170490764540780715 0.49948725625536105621];
IW1_2 = [0.61694997404228268945 -0.87068440469810282067;-1.5488202324699440471 1.4722431732320737652;-1.2089063425006398855 0.32968150345601088258;1.2386696961377492432 -0.68536587394117254313;-2.2199551570033526637 -0.10349385547103898131;1.5121174710044194001 -0.71433232067808516419;0.056459859155360607452 -2.4869893416045631973;-0.86479908485982903699 -1.3762864649859323229;0.7558109911584756091 -2.0399489362798566283;2.303888776456452625 -1.2627079047227034447;-0.70543555171133176529 1.1463036272307292052;0.12386804576517018717 0.49622568369677327871;-0.4698975483730338798 1.5448770137075531483;0.1195791813640576795 0.38304963800126318185;1.6334124179042330827 1.668882274150326861;1.5454751087021074696 -0.43510598037179548658;0.66339556307621982967 0.99425649668053073249;-0.68144655706907675263 1.7673344439836089492;-1.8233747537130735594 -0.88203849106894804954;0.5824061749675695232 -2.2019935314435969964;1.1358602661841272763 -1.7360492499653670251;-0.9057072606532956538 -1.5392016768999590148;-0.09922786408364339672 -2.2225676270181251581;2.4838113413564122389 -2.6729906404837455725;1.4437231285795186775 1.5976345322899507817;1.3614903219154375069 -0.84029987875788292317;-2.1542941789438971867 -0.46469025572296690507;0.45399457118272923406 0.29816979130837562018;-1.1382292991880380573 1.5641915350320498845;1.0763300327294342829 1.580816773450191004;1.5201796243495828698 -0.43953320576883359028;0.28041428886040425938 0.69774916886524696036;1.2982124276151452147 -1.8461919833749178554;-0.3784893335507906742 2.3460784673234775788;1.2051351953216757895 0.7452365028357356147;0.058965171830523244179 -0.96868511460717221517;1.7022523056071801051 -1.7721742439767791399;-1.0633191776217827407 -0.40798897910744286177;-1.4504054949208224912 -0.71584858091221525989;1.339585939656968927 -1.2949849311389705075];

% Layer 2
b2 = 0.60062002891318733155;
LW2_1 = [0.44681451223330542755 1.4076139788776778072 0.34440703254177185144 0.86701980931156286125 -0.58723441602148174212 1.5705205846370879907 1.2861613006532919279 1.1076564214154698274 -0.81387024967158894118 1.0353553163532960291 0.17477415801532139583 0.0035260729609283471969 -0.59590686501434453337 0.21862914671961553026 -0.43012834380962505776 -0.054114453743454318801 0.46325503623288794008 -0.026535099236377014675 -0.37272297466212861439 -0.91513171542390359114 0.63007848103938823847 -0.02971044428590331743 1.154704409488550132 1.1161333571846629997 0.1299746216205678595 -0.77992736757757641364 -0.76692383533416230712 0.54603861964990441091 -0.63430457507684046004 0.10639095261149993099 -0.65974161534362218973 -0.040841951413884594602 -0.54561313572317382548 0.40161558782691858527 -0.45454068033382100111 0.19192639899934282877 -0.43813363791849641027 -1.2724399185404811075 -0.038370864926762032754 0.53155344440559848529];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = 0.00101684770681708;
y1_step1.xoffset = 0;

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(2,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(1,1)];

% Allocate Outputs
y1 = zeros(1,TS);

% Time loop
for ts=1:TS

    % Rotating delay state position
    xdts = mod(ts+1,3)+1;

    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);

    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);

    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),4,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),2,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);

    % Layer 2
    a2 = b2 + LW2_1*a1;

    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
y = bsxfun(@minus,x,settings.xoffset);
y = bsxfun(@times,y,settings.gain);
y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
x = bsxfun(@minus,y,settings.ymin);
x = bsxfun(@rdivide,x,settings.gain);
x = bsxfun(@plus,x,settings.xoffset);
end
